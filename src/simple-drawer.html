<link rel="import" href="../polymer/polymer.html">

<dom-module id="simple-drawer">
  <template>
    <style>
      :host, *, *::before, *::after {
        box-sizing: border-box;
      }

      :host {
        position: fixed;
        display: block;
        top: 0;
        bottom: 0;
        background: white;
        outline: none;
        z-index: 2147483647;
        box-shadow: 0 6px 10px 0 rgba(0, 0, 0, 0.14),
                    0 1px 18px 0 rgba(0, 0, 0, 0.12),
                    0 3px 5px -1px rgba(0, 0, 0, 0.4);
        -moz-osx-font-smoothing: grayscale;
         -webkit-font-smoothing: antialiased;
                 font-smoothing: antialiased;
        transition: transform 125ms cubic-bezier(0.4, 0.0, 1, 1);
      }

      :host(:not([active])) {
        display: none;
      }

      :host([visible]) {
        transform: translateZ(0) translateX(0) !important;
        transition: transform 250ms cubic-bezier(0.0, 0.0, 0.2, 1);
      }

      :host([position="left"]) {
        left: 0;
        transform: translateZ(0) translateX(-100%);
      }

      :host([position="right"]) {
        right: 0;
        transform: translateZ(0) translateX(100%);
      }

      :host([disabled]) {
        display: block;
        position: relative;
        box-shadow: none;
        transform: none !important;
      }
    </style>

    <content></content>

  </template>

  <script>
    class SimpleDrawer {
      beforeRegister() {
        this.is = 'simple-drawer',

        this.properties = {

          /**
           *  Whether drawer is active
           *  @type {Boolean}
           */
          active: {
            type: Boolean,
            reflectToAttribute: true,
            readonly: true
          },

          /**
           *  Wether drawer is visisble
           *  Used by CSS transitions
           *  @type {Boolean}
           */
          visible: {
            type: Boolean,
            reflectToAttribute: true,
            readonly: true
          },

          /**
           * Stop drawer closing on escape keypress
           * @type {Boolean}
           */
          noEscape: Boolean,

          /**
           * Stop drawer closing when it loses focus
           * @type {Boolean}
           */
          noBlur: Boolean,

          /**
           *  Position of the drawer
           *  @type {String} left|right
           */
          position: {
            type: String,
            value: 'left',
            reflectToAttribute: true
          },

          /**
           * Disable the drawer (so it acts like a div)
           * @type {Boolean}
           */
          disabled: {
            type: Boolean,
            reflectToAttribute: true,
            notify: true
          },

          /**
           * Make the drawer focuseable
           * @type {Number}
           */
          tabindex: {
            type: Number,
            reflectToAttribute: true,
            readonly: true,
            value: 0
          }

        };

        this.observers = [
          '_goVisibleOnActive(active)',
          '_closeOnEscape(active)',
          '_focusOnActive(active)'
        ];

        this.listeners = {
          blur: '_closeOnBlur',
          transitionend: '_goInactiveOnClose'
        }
      }

      /**
       * Open the drawer
       * @return {undefined}
       */
      open() {
        this.active = true;
      }

      /**
       * Close the drawer
       * @return {undefined}
       */
      close() {
        this.visible = false;
      }

      /**
       * Toggle the drawer
       * @return {undefined}
       */
      toggle() {
        if (this.active) {
          this.close();
        } else {
          this.open();
        }
      }

      /**
       * Sets visible on active, after next animation frame
       * For CSS transitions
       * @param  {Boolean} active Value of the active property
       * @return {undefined}
       */
      _goVisibleOnActive(active) {
        if (active) {
          Polymer.RenderStatus
            .afterNextRender(this, () => this.visible = true);
        }
      }

      /**
       * Sets active false if visisble false after
       * Called on transition ends
       * @param  {Event} e Transitionend event
       * @return {undefined}
       */
      _goInactiveOnClose(e) {
        if (!this.visible) {
          this.active = false;
        }
      }

      /**
       * Autofocus the drawer when it opens
       * @param  {Boolean} active Value of the active prop
       * @return {undefined}
       */
      _focusOnActive(active) {
        if (active) {
          this.focus();
        }
      }

      /**
       * Close the drawer when it loses focus
       * @param  {Event} e Blur event
       * @return {undefined}
       */
      _closeOnBlur(e) {
        if (!this.noBlur) {
          this.close();
        }
      }

      /**
       * Close the drawer on escape keypress if active
       * @param  {Boolean} active Value of the active property
       * @return {undefined}
       */
      _closeOnEscape(active) {
        let closeIfEscape = (e) => {
          if (e.keyCode === 27 && !this.noEscape) {
            this.active = false;
          }
        };

        if (active) {
          document.addEventListener('keydown', closeIfEscape);
        } else {
          document.removeEventListener('keydown', closeIfEscape);
        }
      }

      /**
       * Lock the document body when drawer is open
       * @param  {Boolean} active Value of the active property
       * @return {undefined}
       */
      _lockBodyWhenOpen(active) {
        let bodyStyle = document.body.style;

        if (active) {
          bodyStyle.overflow = 'hidden';
        } else {
          bodyStyle.overflow = '';
        }
      }
    };
    Polymer(SimpleDrawer)
  </script>
</dom-module>
